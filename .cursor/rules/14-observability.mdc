---
description: Observability-’´ ’Ø’°’∂’∏’∂’∂’•÷Ä÷â ‘º’∏’£’°’æ’∏÷Ä’∏÷Ç’¥, ’¥’•’ø÷Ä’´’Ø’°’∂’•÷Ä, ’∞’•’ø’°’£’Æ’∏÷Ç’¥, ’¥’∏’∂’´’ø’∏÷Ä’´’∂’£÷â
globs: ["**/*.ts", "**/*.tsx", "**/api/**", "**/server/**"]
alwaysApply: false
---

# OBSERVABILITY-‘ª ‘ø‘±’Ü’à’Ü’Ü‘µ’ê

> –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –∏–∑–º–µ—Ä–∏—Ç—å ‚Äî –Ω–µ –º–æ–∂–µ—à—å —É–ª—É—á—à–∏—Ç—å. –õ–æ–≥–∏, –º–µ—Ç—Ä–∏–∫–∏, —Ç—Ä–µ–π—Å—ã = –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã.

---

## üéØ –ì–õ–ê–í–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´

1. **Structured Logging** ‚Äî JSON –ª–æ–≥–∏ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
2. **Correlation** ‚Äî Request ID –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –≤—Å—é —Å–∏—Å—Ç–µ–º—É
3. **Levels** ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
4. **No PII** ‚Äî –Ω–∏–∫–∞–∫–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ª–æ–≥–∞—Ö

---

## üìä –¢–†–ò –°–¢–û–õ–ü–ê OBSERVABILITY

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    OBSERVABILITY                        ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ     LOGS        ‚îÇ    METRICS      ‚îÇ     TRACES          ‚îÇ
‚îÇ                 ‚îÇ                 ‚îÇ                     ‚îÇ
‚îÇ  –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ  ‚îÇ  –°–∫–æ–ª—å–∫–æ/–∫–æ–≥–¥–∞  ‚îÇ  –ü—É—Ç—å –∑–∞–ø—Ä–æ—Å–∞       ‚îÇ
‚îÇ  –î–µ—Ç–∞–ª–∏ —Å–æ–±—ã—Ç–∏–π ‚îÇ  –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ ‚îÇ  –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ     ‚îÇ
‚îÇ  Debug/Troubleshoot‚îÇ –ê–ª–µ—Ä—Ç—ã/–¥–∞—à–±–æ—Ä–¥—ã‚îÇ  –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìù –õ–û–ì–ò–†–û–í–ê–ù–ò–ï

### –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

| –£—Ä–æ–≤–µ–Ω—å | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å | Production |
|---------|-------------------|------------|
| `error` | –û—à–∏–±–∫–∏, —Ç—Ä–µ–±—É—é—â–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è | ‚úÖ –î–∞ |
| `warn` | –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã | ‚úÖ –î–∞ |
| `info` | –í–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ | ‚úÖ –î–∞ |
| `debug` | –î–µ—Ç–∞–ª–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ | ‚ùå –ù–µ—Ç |
| `trace` | –û—á–µ–Ω—å –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è | ‚ùå –ù–µ—Ç |

### –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏

```typescript
// lib/logger.ts
import pino from 'pino';

const isProduction = process.env.NODE_ENV === 'production';

export const logger = pino({
  level: isProduction ? 'info' : 'debug',
  
  // JSON –≤ production, pretty –≤ development
  transport: isProduction
    ? undefined
    : {
        target: 'pino-pretty',
        options: {
          colorize: true,
          translateTime: 'HH:MM:ss',
        },
      },
  
  // –ë–∞–∑–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è –≤—Å–µ—Ö –ª–æ–≥–æ–≤
  base: {
    service: process.env.SERVICE_NAME || 'app',
    env: process.env.NODE_ENV,
    version: process.env.APP_VERSION,
  },
  
  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ timestamp
  timestamp: pino.stdTimeFunctions.isoTime,
  
  // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  redact: {
    paths: [
      'password',
      'passwordHash',
      'token',
      'accessToken',
      'refreshToken',
      'authorization',
      'cookie',
      'creditCard',
      '*.password',
      '*.token',
    ],
    censor: '[REDACTED]',
  },
});

// Child logger —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
export function createLogger(context: Record<string, unknown>) {
  return logger.child(context);
}
```

### –ü—Ä–∞–≤–∏–ª–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

// INFO ‚Äî –≤–∞–∂–Ω—ã–µ –±–∏–∑–Ω–µ—Å-—Å–æ–±—ã—Ç–∏—è
logger.info({
  event: 'order.created',
  orderId: order.id,
  userId: user.id,
  total: order.total,
  itemCount: order.items.length,
}, 'Order created successfully');

// WARN ‚Äî –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
logger.warn({
  event: 'payment.retry',
  orderId,
  attempt: 3,
  maxAttempts: 5,
}, 'Payment retry attempt');

// ERROR ‚Äî –æ—à–∏–±–∫–∏ —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
logger.error({
  event: 'payment.failed',
  orderId,
  errorCode: error.code,
  errorMessage: error.message,
  stack: error.stack,
}, 'Payment processing failed');

// DEBUG ‚Äî –¥–µ—Ç–∞–ª–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–Ω–µ –≤ production)
logger.debug({
  event: 'cache.miss',
  key: cacheKey,
  duration: fetchTime,
}, 'Cache miss, fetched from database');
```

```typescript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û

// –ù–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
logger.info('Order created');

// –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
logger.info({ email, password }, 'User login');

// –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤ info
logger.info({ fullRequest, fullResponse }, 'API call');

// –ù–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ—à–∏–±–∫–∏
logger.error('Something went wrong');
```

### Next.js Request Logging (middleware)

```typescript
// middleware.ts
import { NextRequest, NextResponse } from 'next/server';
import { v4 as uuid } from 'uuid';

export function middleware(req: NextRequest) {
  const requestId = req.headers.get('x-request-id') ?? uuid();
  const start = Date.now();

  const response = NextResponse.next();
  response.headers.set('x-request-id', requestId);

  // Structured log –¥–ª—è Vercel Logs / –ª—é–±–æ–π log collector
  // –í Edge Runtime (middleware) pino –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º structuredClone + stdout
  const log = {
    level: 'info',
    event: 'request',
    requestId,
    method: req.method,
    path: req.nextUrl.pathname,
    userAgent: req.headers.get('user-agent'),
    ip: req.headers.get('x-forwarded-for'),
    timestamp: new Date().toISOString(),
  };
  // eslint-disable-next-line no-console -- Edge Runtime, pino –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
  console.info(JSON.stringify(log));

  return response;
}

export const config = {
  matcher: ['/api/:path*'],
};
```

### Next.js Logging –≤ Route Handlers –∏ Server Actions

```typescript
// lib/logger.ts ‚Äî –µ–¥–∏–Ω—ã–π logger –¥–ª—è Next.js
import pino from 'pino';

export const logger = pino({
  level: process.env.LOG_LEVEL || 'info',
  transport: process.env.NODE_ENV === 'development'
    ? { target: 'pino-pretty' }
    : undefined,
});

// app/api/orders/route.ts ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ route handler
import { NextRequest, NextResponse } from 'next/server';
import { logger } from '@/lib/logger';

export async function POST(req: NextRequest) {
  const reqLogger = logger.child({ handler: 'POST /api/orders' });
  const body = await req.json();

  reqLogger.info({ userId: body.userId }, 'Creating order');

  try {
    const order = await createOrder(body);
    reqLogger.info({ orderId: order.id }, 'Order created');
    return NextResponse.json({ data: order }, { status: 201 });
  } catch (error) {
    reqLogger.error({ err: error }, 'Failed to create order');
    return NextResponse.json({ error: { code: 'SERVER_ERROR' } }, { status: 500 });
  }
}
```

### NestJS/Express Request Logging Middleware

```typescript
// middleware/request-logger.ts
import { Request, Response, NextFunction } from 'express';
import { v4 as uuid } from 'uuid';
import { logger } from '@/lib/logger';

export function requestLogger(
  req: Request,
  res: Response,
  next: NextFunction,
) {
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–ª–∏ –±–µ—Ä—ë–º requestId
  const requestId = (req.headers['x-request-id'] as string) || uuid();
  req.headers['x-request-id'] = requestId;
  res.setHeader('x-request-id', requestId);

  // –¢–∏–ø–∏–∑–∞—Ü–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ Request
  interface AuthenticatedRequest extends Request {
    user?: { id: string };
    logger?: ReturnType<typeof logger.child>;
  }

  const authReq = req as AuthenticatedRequest;

  // –°–æ–∑–¥–∞—ë–º logger —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∑–∞–ø—Ä–æ—Å–∞
  const reqLogger = logger.child({
    requestId,
    method: req.method,
    path: req.path,
    userAgent: req.headers['user-agent'],
    ip: req.ip,
    userId: authReq.user?.id,
  });

  // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
  const startTime = Date.now();

  // –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ –∑–∞–ø—Ä–æ—Å–∞
  reqLogger.info({ event: 'request.start' }, 'Incoming request');

  // –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
  res.on('finish', () => {
    const duration = Date.now() - startTime;
    const level = res.statusCode >= 400 ? 'warn' : 'info';

    reqLogger[level]({
      event: 'request.end',
      statusCode: res.statusCode,
      duration,
    }, `Request completed in ${duration}ms`);
  });

  // –î–æ–±–∞–≤–ª—è–µ–º logger –≤ request –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ handlers
  authReq.logger = reqLogger;

  next();
}
```

### NestJS Logger

```typescript
// common/logger/logger.service.ts
import { Injectable, LoggerService, Scope } from '@nestjs/common';
import { logger as pinoLogger } from '@/lib/logger';
import type { Logger } from 'pino';

@Injectable({ scope: Scope.TRANSIENT })
export class AppLogger implements LoggerService {
  private context?: string;
  private logger: Logger;

  constructor() {
    this.logger = pinoLogger;
  }

  setContext(context: string) {
    this.context = context;
    this.logger = pinoLogger.child({ context });
  }

  log(message: string, context?: Record<string, unknown>) {
    this.logger.info(context || {}, message);
  }

  error(message: string, trace?: string, context?: Record<string, unknown>) {
    this.logger.error({ ...context, stack: trace }, message);
  }

  warn(message: string, context?: Record<string, unknown>) {
    this.logger.warn(context || {}, message);
  }

  debug(message: string, context?: Record<string, unknown>) {
    this.logger.debug(context || {}, message);
  }
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —Å–µ—Ä–≤–∏—Å–µ
@Injectable()
export class OrdersService {
  private readonly logger = new AppLogger();

  constructor() {
    this.logger.setContext(OrdersService.name);
  }

  async create(dto: CreateOrderDto, userId: string) {
    this.logger.log('Creating order', { userId, itemCount: dto.items.length });
    
    try {
      const order = await this.processOrder(dto);
      this.logger.log('Order created', { orderId: order.id, userId });
      return order;
    } catch (error) {
      this.logger.error('Failed to create order', error.stack, {
        userId,
        errorCode: error.code,
      });
      throw error;
    }
  }
}
```

---

## üìà –ú–ï–¢–†–ò–ö–ò

### –¢–∏–ø—ã –º–µ—Ç—Ä–∏–∫

| –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|-----|----------|--------|
| Counter | –°—á—ë—Ç—á–∏–∫ (—Ç–æ–ª—å–∫–æ —Ä–∞—Å—Ç—ë—Ç) | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ |
| Gauge | –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ | –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è |
| Histogram | –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π | –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ |
| Summary | –ö–≤–∞–Ω—Ç–∏–ª–∏ | P50, P95, P99 –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å |

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

```typescript
// metrics/app.metrics.ts
import { Counter, Histogram, Gauge, Summary } from 'prom-client';

// HTTP –º–µ—Ç—Ä–∏–∫–∏
export const httpMetrics = {
  // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
  requestsTotal: new Counter({
    name: 'http_requests_total',
    help: 'Total number of HTTP requests',
    labelNames: ['method', 'path', 'status'],
  }),

  // –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
  requestDuration: new Histogram({
    name: 'http_request_duration_seconds',
    help: 'HTTP request duration in seconds',
    labelNames: ['method', 'path', 'status'],
    buckets: [0.01, 0.05, 0.1, 0.5, 1, 2, 5],
  }),

  // –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
  requestsInProgress: new Gauge({
    name: 'http_requests_in_progress',
    help: 'Number of HTTP requests in progress',
    labelNames: ['method'],
  }),
};

// –ë–∏–∑–Ω–µ—Å –º–µ—Ç—Ä–∏–∫–∏
export const businessMetrics = {
  ordersCreated: new Counter({
    name: 'orders_created_total',
    help: 'Total number of orders created',
    labelNames: ['status'],
  }),

  orderValue: new Histogram({
    name: 'order_value_amount',
    help: 'Order value distribution',
    buckets: [10, 50, 100, 500, 1000, 5000],
  }),

  paymentProcessingTime: new Histogram({
    name: 'payment_processing_seconds',
    help: 'Payment processing time',
    labelNames: ['provider'],
    buckets: [0.5, 1, 2, 5, 10, 30],
  }),
};

// Database –º–µ—Ç—Ä–∏–∫–∏
export const dbMetrics = {
  queryDuration: new Histogram({
    name: 'db_query_duration_seconds',
    help: 'Database query duration',
    labelNames: ['operation', 'table'],
    buckets: [0.001, 0.01, 0.05, 0.1, 0.5, 1],
  }),

  connectionPoolSize: new Gauge({
    name: 'db_connection_pool_size',
    help: 'Database connection pool size',
    labelNames: ['state'], // active, idle, waiting
  }),
};
```

### RED –º–µ—Ç—Ä–∏–∫–∏ (–¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤)

```
Rate     ‚Äî –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É
Errors   ‚Äî –ø—Ä–æ—Ü–µ–Ω—Ç –æ—à–∏–±–æ–∫
Duration ‚Äî –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (P50, P95, P99)
```

### USE –º–µ—Ç—Ä–∏–∫–∏ (–¥–ª—è —Ä–µ—Å—É—Ä—Å–æ–≤)

```
Utilization ‚Äî % –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
Saturation  ‚Äî –æ—á–µ—Ä–µ–¥—å/–æ–∂–∏–¥–∞–Ω–∏–µ
Errors      ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
```

---

## üîó DISTRIBUTED TRACING

### Correlation ID

```typescript
// === Next.js ‚Äî middleware.ts ===
import { NextRequest, NextResponse } from 'next/server';
import { v4 as uuid } from 'uuid';

export function middleware(req: NextRequest) {
  const correlationId =
    req.headers.get('x-correlation-id') ??
    req.headers.get('x-request-id') ??
    uuid();

  // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –≤ headers –¥–ª—è route handlers
  const requestHeaders = new Headers(req.headers);
  requestHeaders.set('x-correlation-id', correlationId);

  const response = NextResponse.next({ request: { headers: requestHeaders } });
  response.headers.set('x-correlation-id', correlationId);
  return response;
}

// –ß—Ç–µ–Ω–∏–µ –≤ route handler:
// const correlationId = req.headers.get('x-correlation-id');

// === NestJS/Express ‚Äî middleware/correlation.ts ===
import { AsyncLocalStorage } from 'async_hooks';
import { v4 as uuid } from 'uuid';
import { Request, Response, NextFunction } from 'express';

const correlationStorage = new AsyncLocalStorage<{ correlationId: string }>();

export function correlationMiddleware(
  req: Request,
  res: Response,
  next: NextFunction,
) {
  const correlationId = 
    (req.headers['x-correlation-id'] as string) ??
    (req.headers['x-request-id'] as string) ??
    uuid();

  req.headers['x-correlation-id'] = correlationId;
  res.setHeader('x-correlation-id', correlationId);

  // –î–æ–±–∞–≤–ª—è–µ–º –≤ AsyncLocalStorage –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –≤–µ–∑–¥–µ
  correlationStorage.run({ correlationId }, () => {
    next();
  });
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ correlation ID –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ –∫–æ–¥–∞
export function getCorrelationId(): string | undefined {
  return correlationStorage.getStore()?.correlationId;
}
```

### –ü–µ—Ä–µ–¥–∞—á–∞ –≤ –≤–Ω–µ—à–Ω–∏–µ –≤—ã–∑–æ–≤—ã

```typescript
// lib/api-client.ts

export async function externalApiCall<T>(
  url: string,
  options?: RequestInit,
): Promise<T> {
  const correlationId = getCorrelationId();

  const response = await fetch(url, {
    ...options,
    headers: {
      ...options?.headers,
      'x-correlation-id': correlationId || uuid(),
    },
  });

  return response.json();
}
```

### OpenTelemetry (–¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤)

```typescript
// instrumentation.ts
import { NodeSDK } from '@opentelemetry/sdk-node';
import { getNodeAutoInstrumentations } from '@opentelemetry/auto-instrumentations-node';
import { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-http';

const sdk = new NodeSDK({
  serviceName: process.env.SERVICE_NAME,
  traceExporter: new OTLPTraceExporter({
    url: process.env.OTEL_EXPORTER_OTLP_ENDPOINT,
  }),
  instrumentations: [
    getNodeAutoInstrumentations({
      '@opentelemetry/instrumentation-fs': { enabled: false },
    }),
  ],
});

sdk.start();
```

---

## üö® –ê–õ–ï–†–¢–ò–ù–ì

### –ü—Ä–∞–≤–∏–ª–∞ –∞–ª–µ—Ä—Ç–æ–≤

```yaml
# –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (—Å—Ä–æ—á–Ω–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å)
- alert: HighErrorRate
  condition: error_rate > 5%
  for: 5m
  severity: critical

- alert: ServiceDown
  condition: up == 0
  for: 1m
  severity: critical

# –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (—Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è)
- alert: HighLatency
  condition: p99_latency > 2s
  for: 10m
  severity: warning

- alert: DiskSpaceRunningLow
  condition: disk_usage > 80%
  for: 30m
  severity: warning
```

### SLI/SLO (Service Level Indicators/Objectives)

```markdown
## SLO –¥–ª—è API

| –ú–µ—Ç—Ä–∏–∫–∞ | SLO | –ò–∑–º–µ—Ä–µ–Ω–∏–µ |
|---------|-----|-----------|
| Availability | 99.9% | –£—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã / –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã |
| Latency P99 | < 500ms | 99-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞ |
| Error Rate | < 0.1% | 5xx –æ—à–∏–±–∫–∏ / –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã |

## Error Budget

- SLO 99.9% = 0.1% –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –æ—à–∏–±–æ–∫
- 43.2 –º–∏–Ω—É—Ç—ã downtime –≤ –º–µ—Å—è—Ü
- –ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω ‚Äî –∑–∞–º–æ—Ä–æ–∑–∫–∞ —Ä–µ–ª–∏–∑–æ–≤
```

---

## üìã –ß–¢–û –õ–û–ì–ò–†–û–í–ê–¢–¨

### ‚úÖ –õ–û–ì–ò–†–£–ô

```typescript
// –ë–∏–∑–Ω–µ—Å-—Å–æ–±—ã—Ç–∏—è
logger.info({ event: 'user.registered', userId });
logger.info({ event: 'order.created', orderId, total });
logger.info({ event: 'payment.completed', orderId, amount });

// –û—à–∏–±–∫–∏ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
logger.error({ event: 'payment.failed', orderId, errorCode, stack });

// –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
logger.info({ event: 'db.query', duration, query: 'findUsers' });

// Security —Å–æ–±—ã—Ç–∏—è
logger.warn({ event: 'auth.failed', ip, email: maskEmail(email) });
logger.info({ event: 'password.changed', userId });
```

### ‚ùå –ù–ï –õ–û–ì–ò–†–£–ô

```typescript
// –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
logger.info({ password, ssn, creditCard }); // ‚ùå

// –¢–æ–∫–µ–Ω—ã –∏ —Å–µ–∫—Ä–µ—Ç—ã
logger.debug({ accessToken, apiKey }); // ‚ùå

// –°–ª–∏—à–∫–æ–º –¥–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
logger.info({ fullRequestBody, fullResponseBody }); // ‚ùå

// –ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏
logger.debug('Entering function X'); // ‚ùå –°–ª–∏—à–∫–æ–º —à—É–º–Ω–æ
```

---

## üìã CHECKLIST

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

- [ ] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è structured logging (JSON)
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ (info –≤ prod)
- [ ] Request ID –≤ –∫–∞–∂–¥–æ–º –ª–æ–≥–µ
- [ ] –ù–µ—Ç PII/—Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –ª–æ–≥–∞—Ö
- [ ] –û—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏ stack trace
- [ ] –ë–∏–∑–Ω–µ—Å-—Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

### –ú–µ—Ç—Ä–∏–∫–∏

- [ ] HTTP –º–µ—Ç—Ä–∏–∫–∏ (rate, errors, duration)
- [ ] –ë–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏ (orders, payments, etc.)
- [ ] Database –º–µ—Ç—Ä–∏–∫–∏ (query time, connections)
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ /metrics endpoint

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- [ ] –î–∞—à–±–æ—Ä–¥—ã –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫
- [ ] –ê–ª–µ—Ä—Ç—ã –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è
- [ ] SLO –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è

---

**–í–µ—Ä—Å–∏—è:** 1.1
**–î–∞—Ç–∞:** 2026-02-12
