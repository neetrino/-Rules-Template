---
description: ‘±’∂’æ’ø’°’∂’£’∏÷Ç’©’µ’°’∂ ’Ø’°’∂’∏’∂’∂’•÷Ä÷â ’î’ê‘ª’è‘ª‘ø‘±‘ø‘±’Ü÷â ‘ø’´÷Ä’°’º’æ’∏÷Ç’¥ ’ß ’°’¥’¢’∏’≤’ª ’Ø’∏’§’´’∂÷â
globs: ["**/*.ts", "**/*.tsx", "**/*.env*", "**/api/**", "**/auth/**", "**/middleware*"]
alwaysApply: false
---

# ‘±’Ü’é’è‘±’Ü‘≥’à’í‘π’Ö‘±’Ü ‘ø‘±’Ü’à’Ü’Ü‘µ’ê

> ‘±’∂’æ’ø’°’∂’£’∏÷Ç’©’µ’∏÷Ç’∂’® ’®’∂’ø÷Ä’∏÷Ç’©’µ’∏÷Ç’∂ ’π’ß, ’°’µ’¨ ’∫’°’∞’°’∂’ª÷â ‘±’µ’Ω ’Ø’°’∂’∏’∂’∂’•÷Ä’® ’ä‘±’ê’è‘±‘¥‘ª’ê ’•’∂÷â

---

## üö® ’î’ê‘ª’è‘ª‘ø‘±‘ø‘±’Ü ‘ø‘±’Ü’à’Ü’Ü‘µ’ê

### ‘µ’ê‘µ’î‘µ‘º‘µ’é ’¥’´’õ ’°÷Ä’°

```typescript
// ‚ùå –ù–ò–ö–û–ì–î–ê ‚Äî —Å–µ–∫—Ä–µ—Ç—ã –≤ –∫–æ–¥–µ
const API_KEY = 'sk_live_abc123';
const DB_PASSWORD = 'mypassword';

// ‚ùå –ù–ò–ö–û–ì–î–ê ‚Äî SQL –∏–Ω—ä–µ–∫—Ü–∏–∏
const query = `SELECT * FROM users WHERE id = ${userId}`;
await db.$queryRawUnsafe(query);

// ‚ùå –ù–ò–ö–û–ì–î–ê ‚Äî eval –∏ –ø–æ–¥–æ–±–Ω—ã–µ
eval(userInput);
new Function(userInput)();

// ‚ùå –ù–ò–ö–û–ì–î–ê ‚Äî –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
app.use(cors({ origin: '*' })); // –¢–æ–ª—å–∫–æ –¥–ª—è dev!
// CSRF –æ—Ç–∫–ª—é—á–µ–Ω

// ‚ùå –ù–ò–ö–û–ì–î–ê ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤
console.log('Password:', password);
logger.info({ token: accessToken });
```

---

## üîê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø

### –ü–∞—Ä–æ–ª–∏

```typescript
// ‚úÖ –•—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π
import { hash, verify, argon2id } from 'argon2';

// –•—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
const passwordHash = await hash(password, {
  type: argon2id,
  memoryCost: 65536,  // 64 MB
  timeCost: 3,
  parallelism: 4,
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ
const isValid = await verify(user.passwordHash, password);

// ‚ùå –ù–ò–ö–û–ì–î–ê
const passwordHash = md5(password);     // –°–ª–∞–±—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º
const passwordHash = sha256(password);  // –ë–µ–∑ salt
```

### JWT –¢–æ–∫–µ–Ω—ã

```typescript
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ JWT (HS256 + symmetric secret)
import jwt from 'jsonwebtoken';

const accessToken = jwt.sign(
  { userId: user.id, role: user.role },
  process.env.JWT_SECRET!,
  { 
    expiresIn: '15m',           // –ö–æ—Ä–æ—Ç–∫–∏–π —Å—Ä–æ–∫
    algorithm: 'HS256',         // –°–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º (secret string)
    issuer: 'api.example.com',
    audience: 'example.com',
  }
);

// Refresh token ‚Äî –¥–ª–∏–Ω–Ω—ã–π —Å—Ä–æ–∫, —Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î
const refreshToken = jwt.sign(
  { userId: user.id, tokenId: uuid() },
  process.env.JWT_REFRESH_SECRET!,
  { expiresIn: '7d' }
);

// –ï—Å–ª–∏ –Ω—É–∂–µ–Ω RS256 (–∞—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–π) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π key pair:
// const accessToken = jwt.sign(payload, privateKey, { algorithm: 'RS256' });

// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û
const token = jwt.sign(payload, 'secret'); // –°–ª–∞–±—ã–π —Å–µ–∫—Ä–µ—Ç
jwt.sign(payload, secret, { expiresIn: '30d' }); // –°–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –¥–ª—è access
```

### –°–µ—Å—Å–∏–∏

```typescript
// ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∫—É–∫–∏ –¥–ª—è —Å–µ—Å—Å–∏–π
res.cookie('sessionId', sessionId, {
  httpOnly: true,     // –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ JS
  secure: true,       // –¢–æ–ª—å–∫–æ HTTPS
  sameSite: 'strict', // –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF
  maxAge: 7 * 24 * 60 * 60 * 1000, // 7 –¥–Ω–µ–π
  path: '/',
  domain: '.example.com',
});
```

---

## üõ°Ô∏è –ó–ê–©–ò–¢–ê –û–¢ –ê–¢–ê–ö

### XSS (Cross-Site Scripting)

```typescript
// ‚úÖ –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–≤–æ–¥–∞
import { escape } from 'html-escaper';

const safeHtml = escape(userInput);

// ‚úÖ Content Security Policy
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'"],
      styleSrc: ["'self'", "'unsafe-inline'"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'", "https://api.example.com"],
    },
  },
}));

// ‚úÖ React –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç
return <div>{userInput}</div>; // –ë–µ–∑–æ–ø–∞—Å–Ω–æ

// ‚ùå –û–ü–ê–°–ù–û ‚Äî dangerouslySetInnerHTML
<div dangerouslySetInnerHTML={{ __html: userInput }} />
```

### CSRF (Cross-Site Request Forgery)

```typescript
// ‚úÖ Next.js ‚Äî Server Actions –∏–º–µ—é—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é CSRF-–∑–∞—â–∏—Ç—É
// (origin –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, SameSite cookies)
// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ ‚Äî SameSite cookies –¥–ª—è —Å–µ—Å—Å–∏–π:
cookies().set('session', value, { sameSite: 'strict', httpOnly: true, secure: true });

// ‚úÖ NestJS ‚Äî –∫–∞—Å—Ç–æ–º–Ω—ã–π CSRF guard
// –í–∞—Ä–∏–∞–Ω—Ç 1: Double Submit Cookie
@Injectable()
export class CsrfGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const req = context.switchToHttp().getRequest();
    const cookieToken = req.cookies['csrf-token'];
    const headerToken = req.headers['x-csrf-token'];
    if (!cookieToken || cookieToken !== headerToken) {
      throw new ForbiddenException('Invalid CSRF token');
    }
    return true;
  }
}

// ‚úÖ SameSite cookies (–æ–±–∞ —Å—Ç–µ–∫–∞)
res.cookie('session', value, { sameSite: 'strict' });
```

> ‚ö†Ô∏è –ü–∞–∫–µ—Ç `csurf` deprecated (–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω —Å 2022). –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ.

### SQL Injection

```typescript
// ‚úÖ Prisma –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—â–∏—â–∞–µ—Ç
const user = await prisma.user.findFirst({
  where: { email: userInput }, // –ë–µ–∑–æ–ø–∞—Å–Ω–æ
});

// ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
const result = await prisma.$queryRaw`
  SELECT * FROM users WHERE email = ${userInput}
`; // –ë–µ–∑–æ–ø–∞—Å–Ω–æ ‚Äî Prisma —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç

// ‚ùå –ù–ò–ö–û–ì–î–ê
await prisma.$queryRawUnsafe(
  `SELECT * FROM users WHERE email = '${userInput}'`
);
```

### NoSQL Injection

```typescript
// ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–æ–≤
const userId = z.string().uuid().parse(userInput);

// ‚ùå –û–ü–ê–°–ù–û ‚Äî –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
const user = await db.findOne({ 
  _id: userInput // –ú–æ–∂–µ—Ç –±—ã—Ç—å { $ne: null }
});
```

---

## üîí –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø

### RBAC (Role-Based Access Control)

```typescript
// ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π
@UseGuards(JwtAuthGuard, RolesGuard)
@Roles('admin', 'manager')
@Delete(':id')
async delete(@Param('id') id: string) {
  return this.service.delete(id);
}

// ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ä–µ—Å—É—Ä—Å–∞
async updateOrder(orderId: string, userId: string, data: UpdateOrderDto) {
  const order = await this.prisma.order.findUnique({
    where: { id: orderId },
  });
  
  if (!order) {
    throw new NotFoundException();
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞
  if (order.userId !== userId) {
    throw new ForbiddenException('You can only edit your own orders');
  }
  
  return this.prisma.order.update({
    where: { id: orderId },
    data,
  });
}
```

### –ü—Ä–∏–Ω—Ü–∏–ø –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π

```typescript
// ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–π —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
const user = await prisma.user.findUnique({
  where: { id },
  select: {
    id: true,
    name: true,
    email: true,
    // –ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–π: passwordHash, role, internalNotes
  },
});

// ‚úÖ –†–∞–∑–Ω—ã–µ DTO –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –¥–æ—Å—Ç—É–ø–∞
export class UserPublicDto {
  id: string;
  name: string;
}

export class UserPrivateDto extends UserPublicDto {
  email: string;
  phone: string;
}

export class UserAdminDto extends UserPrivateDto {
  role: string;
  createdAt: Date;
  lastLoginAt: Date;
}
```

---

## üîë –°–ï–ö–†–ï–¢–´

### –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤

```bash
# ‚úÖ Environment variables
DATABASE_URL=postgresql://...
JWT_SECRET=very-long-random-string
API_KEY=sk_live_...

# .env —Ñ–∞–π–ª –≤ .gitignore
# ‚ùå –ù–ò–ö–û–ì–î–ê –Ω–µ –∫–æ–º–º–∏—Ç—å .env

# ‚úÖ Production ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π secrets manager
# - AWS Secrets Manager
# - HashiCorp Vault
# - Kubernetes Secrets
```

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤

```bash
# ‚úÖ –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ —Å—Ç–æ–π–∫–∏–µ —Å–µ–∫—Ä–µ—Ç—ã
openssl rand -base64 32  # –î–ª—è JWT_SECRET
openssl rand -hex 32     # –î–ª—è API –∫–ª—é—á–µ–π

# ‚ùå –ù–ò–ö–û–ì–î–ê
JWT_SECRET=secret
JWT_SECRET=12345
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

```typescript
// ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
import { z } from 'zod';

const envSchema = z.object({
  DATABASE_URL: z.string().url(),
  JWT_SECRET: z.string().min(32),
  NODE_ENV: z.enum(['development', 'production', 'test']),
});

const env = envSchema.parse(process.env);

export default env;
```

---

## üìù –í–ê–õ–ò–î–ê–¶–ò–Ø –í–•–û–î–ù–´–• –î–ê–ù–ù–´–•

### –û–±—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞

```typescript
// ‚úÖ –í–∞–ª–∏–¥–∏—Ä—É–π –í–°–Å –Ω–∞ –≤—Ö–æ–¥–µ
import { z } from 'zod';

const createUserSchema = z.object({
  email: z.string().email().max(255),
  password: z.string().min(8).max(100),
  name: z.string().min(1).max(100).optional(),
});

// ‚úÖ –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è
const sanitizedInput = input
  .trim()
  .replace(/[<>]/g, ''); // –£–¥–∞–ª—è–µ–º HTML —Ç–µ–≥–∏

// ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
app.use(express.json({ limit: '1mb' }));
app.use(express.urlencoded({ limit: '1mb', extended: true }));
```

### –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤

```typescript
// ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ –∏ —Ä–∞–∑–º–µ—Ä–∞
const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];
const MAX_SIZE = 5 * 1024 * 1024; // 5MB

async function uploadFile(file: Express.Multer.File) {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ MIME type
  if (!ALLOWED_TYPES.includes(file.mimetype)) {
    throw new BadRequestException('Invalid file type');
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
  if (file.size > MAX_SIZE) {
    throw new BadRequestException('File too large');
  }
  
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–π –Ω–æ–≤–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
  const filename = `${uuid()}${path.extname(file.originalname)}`;
  
  // –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π originalname –Ω–∞–ø—Ä—è–º—É—é!
}
```

---

## üåê HTTPS –ò –ó–ê–ì–û–õ–û–í–ö–ò

### Security Headers

```typescript
// ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π helmet
import helmet from 'helmet';

app.use(helmet());

// –ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–π –≤—Ä—É—á–Ω—É—é
app.use((req, res, next) => {
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('X-Frame-Options', 'DENY');
  res.setHeader('X-XSS-Protection', '1; mode=block');
  res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');
  res.setHeader('Content-Security-Policy', "default-src 'self'");
  next();
});
```

### CORS

```typescript
// ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ CORS
app.use(cors({
  origin: [
    'https://example.com',
    'https://admin.example.com',
  ],
  methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true,
  maxAge: 86400, // 24 —á–∞—Å–∞
}));

// ‚ùå –ù–ò–ö–û–ì–î–ê –≤ production
app.use(cors({ origin: '*' }));
```

---

## üìä –õ–û–ì–ò–†–û–í–ê–ù–ò–ï

### –ß—Ç–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å

```typescript
// ‚úÖ –õ–æ–≥–∏—Ä—É–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
logger.info('User logged in', { userId: user.id, ip: req.ip });
logger.warn('Failed login attempt', { email, ip: req.ip, attempts });
logger.error('Payment failed', { orderId, errorCode });

// ‚ùå –ù–ò–ö–û–ì–î–ê –Ω–µ –ª–æ–≥–∏—Ä—É–π
logger.info('Login', { email, password }); // –ü–∞—Ä–æ–ª—å!
logger.debug('Token', { accessToken });    // –¢–æ–∫–µ–Ω!
logger.info('Card', { cardNumber });       // –ü–ª–∞—Ç—ë–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!
```

### –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

```typescript
// ‚úÖ –ú–∞—Å–∫–∏—Ä—É–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
function maskEmail(email: string): string {
  const [local, domain] = email.split('@');
  return `${local[0]}***@${domain}`;
}

function maskCard(card: string): string {
  return `****${card.slice(-4)}`;
}

logger.info('Payment processed', {
  email: maskEmail(user.email),
  card: maskCard(cardNumber),
});
```

---

## üìã SECURITY CHECKLIST

### –ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

- [ ] –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ environment variables
- [ ] .env –≤ .gitignore
- [ ] HTTPS –≤–∫–ª—é—á—ë–Ω
- [ ] Security headers –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] CORS –æ–≥—Ä–∞–Ω–∏—á–µ–Ω
- [ ] Rate limiting –≤–∫–ª—é—á—ë–Ω
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –ü–∞—Ä–æ–ª–∏ —Ö—ç—à–∏—Ä—É—é—Ç—Å—è (argon2/bcrypt)
- [ ] JWT —Å –∫–æ—Ä–æ—Ç–∫–∏–º —Å—Ä–æ–∫–æ–º –∂–∏–∑–Ω–∏
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤
- [ ] SQL injection –∑–∞—â–∏—Ç–∞ (ORM)
- [ ] XSS –∑–∞—â–∏—Ç–∞ (CSP)
- [ ] CSRF –∑–∞—â–∏—Ç–∞

### –†–µ–≥—É–ª—è—Ä–Ω–æ

- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (npm audit)
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–∏
- [ ] –†–µ–≤—å—é –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

---

---

## ‚òÅÔ∏è –•–†–ê–ù–ò–õ–ò–©–ï –§–ê–ô–õ–û–í (CLOUDFLARE R2)

> Cloudflare R2 ‚Äî –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤. `public/` —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∞—Å—Å–µ—Ç–æ–≤ (favicon, robots.txt, og-image).

### Env variables (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–æ–µ–∫—Ç–∞)

```bash
R2_ACCOUNT_ID="your_account_id"
R2_ACCESS_KEY_ID="your_access_key"
R2_SECRET_ACCESS_KEY="your_secret_key"
R2_BUCKET_NAME="your_bucket_name"
R2_PUBLIC_URL="https://pub-xxx.r2.dev"  # –∏–ª–∏ custom domain
```

### S3-compatible –∫–ª–∏–µ–Ω—Ç (–æ–±—â–∏–π –¥–ª—è –æ–±–æ–∏—Ö —Å—Ç–µ–∫–æ–≤)

```typescript
// lib/r2.ts
import { S3Client, PutObjectCommand, GetObjectCommand, DeleteObjectCommand } from '@aws-sdk/client-s3';

export const r2 = new S3Client({
  region: 'auto',
  endpoint: `https://${process.env.R2_ACCOUNT_ID}.r2.cloudflarestorage.com`,
  credentials: {
    accessKeyId: process.env.R2_ACCESS_KEY_ID!,
    secretAccessKey: process.env.R2_SECRET_ACCESS_KEY!,
  },
});

export async function uploadFile(key: string, body: Buffer, contentType: string) {
  await r2.send(new PutObjectCommand({
    Bucket: process.env.R2_BUCKET_NAME!,
    Key: key,
    Body: body,
    ContentType: contentType,
  }));
  return `${process.env.R2_PUBLIC_URL}/${key}`;
}
```

### Next.js ‚Äî Route Handler (upload)

```typescript
// app/api/upload/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { uploadFile } from '@/lib/r2';
import { nanoid } from 'nanoid';

const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp', 'application/pdf'];
const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10 MB

export async function POST(req: NextRequest) {
  const formData = await req.formData();
  const file = formData.get('file') as File;
  if (!file) return NextResponse.json({ error: 'No file' }, { status: 400 });

  // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–∏–ø–∞ –∏ —Ä–∞–∑–º–µ—Ä–∞
  if (!ALLOWED_TYPES.includes(file.type)) {
    return NextResponse.json({ error: 'File type not allowed' }, { status: 400 });
  }
  if (file.size > MAX_FILE_SIZE) {
    return NextResponse.json({ error: 'File too large (max 10MB)' }, { status: 400 });
  }

  const buffer = Buffer.from(await file.arrayBuffer());
  const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
  const key = `uploads/${nanoid()}-${safeName}`;
  const url = await uploadFile(key, buffer, file.type);

  return NextResponse.json({ url });
}
```

### NestJS ‚Äî Upload —á–µ—Ä–µ–∑ Multer

```typescript
// files/files.controller.ts
@Controller('files')
export class FilesController {
  constructor(private readonly filesService: FilesService) {}

  @Post('upload')
  @UseInterceptors(FileInterceptor('file'))
  async upload(@UploadedFile() file: Express.Multer.File) {
    // –°–∞–Ω–∏—Ç–∏–∑–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ (—É–±–∏—Ä–∞–µ–º —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã, –ø—Ä–æ–±–µ–ª—ã)
    const safeName = file.originalname.replace(/[^a-zA-Z0-9._-]/g, '_');
    const key = `uploads/${nanoid()}-${safeName}`;
    const url = await this.filesService.upload(key, file.buffer, file.mimetype);
    return { url };
  }
}
```

### –ü—Ä–∞–≤–∏–ª–∞

- ‚úÖ –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ–∞–π–ª—ã ‚Üí R2
- ‚úÖ `public/` ‚Üí —Ç–æ–ª—å–∫–æ favicon.ico, robots.txt, sitemap.xml, og-image
- ‚úÖ Env vars –¥–ª—è R2 –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–æ–µ–∫—Ç–∞
- ‚ùå –ù–µ —Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ–∞–π–ª—ã –≤ public/
- ‚ùå –ù–µ –∫–æ–º–º–∏—Ç–∏—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π

---

**–í–µ—Ä—Å–∏—è:** 1.1
**–î–∞—Ç–∞:** 2026-02-12
